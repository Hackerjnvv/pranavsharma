<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Birthday Data Master - Search & Filter</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1e40af;
            --accent-color: #334155;
            --accent-hover: #1e293b;
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #0f172a;
            --text-light: #64748b;
            --border-color: #e2e8f0;
            --success-color: #10b981;
            --info-color: #0ea5e9;
            --section-header-bg: #f8fafc; /* Lighter than th background */
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            -webkit-text-size-adjust: 100%;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 3rem 1rem 4rem 1rem;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 2.2rem;
            margin: 0 0 10px 0;
        }

        header p {
            background: rgba(255, 255, 255, 0.15);
            padding: 6px 16px;
            border-radius: 50px;
            display: inline-block;
            font-size: 0.9rem;
            backdrop-filter: blur(5px);
        }
        
        header p i { color: white; margin-right: 5px; }

        .container {
            max-width: 1200px;
            margin: -50px auto 40px auto;
            padding: 0 20px;
            position: relative;
            z-index: 10;
        }

        .controls-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 15px; /* Unified gap */
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }
        
        .search-wrapper {
            flex-grow: 1;
            display: flex;
            gap: 15px;
            align-items: center;
            min-width: 250px;
        }

        .input-group { position: relative; flex-grow: 1; }
        .sr-only {
            position: absolute; width: 1px; height: 1px; padding: 0;
            margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0);
            white-space: nowrap; border-width: 0;
        }

        .search-input {
            width: 100%; padding: 12px 16px 12px 40px; border: 2px solid var(--border-color);
            border-radius: 8px; font-size: 1rem; font-family: 'Inter', sans-serif;
            transition: border-color 0.2s;
        }
        .search-input:focus { outline: none; border-color: var(--primary-color); }
        .search-icon {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            color: var(--text-light); font-size: 1.1rem;
        }

        .count-badge {
            background-color: #ecfdf5; color: var(--success-color); padding: 8px 16px;
            border-radius: 8px; font-weight: 700; font-size: 0.95rem;
            border: 1px solid #d1fae5; white-space: nowrap;
        }

        /* Button Group for Contact & Info */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .btn {
            color: white; padding: 12px 24px; border-radius: 8px;
            text-decoration: none; font-weight: 600; font-size: 0.95rem;
            transition: all 0.2s ease; display: inline-flex; align-items: center;
            gap: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; cursor: pointer;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 8px rgba(0,0,0,0.15); }
        .btn i { font-size: 1.1em; }

        .contact-btn { background-color: var(--accent-color); }
        .contact-btn:hover { background-color: var(--accent-hover); }

        .info-btn {
            background-color: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            box-shadow: none;
        }
        .info-btn:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(37,99,235,0.2);
        }

        .table-card {
            background: var(--card-bg); border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden; border: 1px solid var(--border-color);
        }
        .table-wrapper { max-height: 65vh; overflow-y: auto; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th, td { padding: 16px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th {
            background-color: #f8fafc; color: var(--text-main); font-weight: 600;
            position: sticky; top: 0; z-index: 5; border-bottom: 2px solid var(--border-color);
        }
        tbody tr:hover { background-color: #f1f5f9; }

        /* --- NEW: Section Header Style --- */
        .section-header td {
            background-color: var(--section-header-bg);
            color: var(--primary-color);
            font-weight: 700;
            font-family: 'Poppins', sans-serif;
            font-size: 1.05rem;
            padding-top: 20px;
            padding-bottom: 12px;
            border-top: 2px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }
        tr.section-header:first-child td {
             border-top: none;
        }

        #loading { padding: 40px; text-align: center; color: var(--text-light); }
        .spinner {
            border: 3px solid #e2e8f0; border-top: 3px solid var(--primary-color);
            border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(15, 23, 42, 0.6);
            display: none; /* Hidden by default */
            align-items: center; justify-content: center; z-index: 1000;
            padding: 20px; backdrop-filter: blur(4px);
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background-color: var(--card-bg); border-radius: 12px;
            padding: 30px 35px; max-width: 750px; width: 100%;
            max-height: 85vh; overflow-y: auto; position: relative;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-close {
            position: absolute; top: 15px; right: 20px;
            background: none; border: none; font-size: 1.8rem;
            color: var(--text-light); cursor: pointer; transition: color 0.2s;
        }
        .modal-close:hover { color: var(--text-main); }
        .modal-content h2 { font-family: 'Poppins', sans-serif; margin-top: 0; color: var(--primary-color); }
        .modal-content h3 { font-family: 'Poppins', sans-serif; margin-top: 25px; border-left: 3px solid var(--primary-color); padding-left: 10px; }
        .modal-content p, .modal-content li { line-height: 1.6; color: var(--text-light); }
        .modal-content strong { color: var(--text-main); }

        @media (max-width: 1000px) {
            .table-wrapper { overflow-x: hidden; }
            table { white-space: normal; }
            th, td { word-break: break-word; }
        }
        @media (max-width: 768px) {
            .container { padding: 0 15px; }
            .controls-card, .button-group { flex-direction: column; align-items: stretch; }
            .search-wrapper { flex-direction: column; align-items: stretch; }
            .count-badge, .btn { text-align: center; justify-content: center; }
            header { padding-bottom: 3.5rem; }
            header h1 { font-size: 1.8rem; }
        }
        @media (max-width: 480px) {
            .container { padding: 0 10px; }
            .controls-card { padding: 15px; }
            th, td { padding: 12px 8px; font-size: 0.8rem; }
        }
    </style>
</head>
<body>

    <header>
        <h1>Birthday Data Master</h1>
        <p><i class="fa-solid fa-circle-info"></i> Data extracted daily from <strong>davjehanabad.in</strong> at 11:00 AM IST</p>
    </header>

    <div class="container">
        <div class="controls-card">
            <div class="search-wrapper">
                <label class="input-group">
                    <span class="sr-only">Search by Class, Section, or Name</span>
                    <span class="search-icon"><i class="fa-solid fa-magnifying-glass"></i></span>
                    <input type="text" id="searchInput" class="search-input" placeholder="Search Class, Section, Name...">
                </label>
                <div id="studentCount" class="count-badge">Total Students: 0</div>
            </div>

            <div class="button-group">
                <button id="readMoreBtn" class="btn info-btn">
                    <i class="fa-solid fa-book-open"></i> Read about this project
                </button>
                <a href="https://pranav-sharma.pages.dev/#contact" target="_blank" rel="noopener noreferrer" class="btn contact-btn">
                    <i class="fa-solid fa-address-card"></i> Contact Developer
                </a>
            </div>
        </div>

        <div class="table-card">
            <div id="loading"><div class="spinner"></div>Loading data...</div>
            <div id="table-container" class="table-wrapper"></div>
        </div>
    </div>

    <div id="infoModal" class="modal-overlay">
        <div class="modal-content">
            <button id="modalCloseBtn" class="modal-close">&times;</button>
            <h2>About The Birthday Data Master</h2>
            <h3>Why Does This Project Exist?</h3>
            <p>The official DAV Jehanabad website features a list of daily birthdays, which is a great way to celebrate students. However, this information is temporaryâ€”once the day is over, the list is gone forever. This makes it impossible to check a birthday you might have missed or to plan for upcoming celebrations.</p>
            <p>The Birthday Data Master was created to solve this simple problem. It enhances the school's feature by turning the fleeting daily list into a <strong>permanent, searchable, and useful archive</strong> for the entire school community.</p>
            <h3>How It Works: The Full Story</h3>
            <p>The application is split into two parts: a silent <strong>Backend</strong> that gathers data and a fast <strong>Frontend</strong> that you interact with.</p>
            <h4>Part 1: The Backend (The Automated Data Engine)</h4>
            <p>The backend's only job is to get fresh data, clean it, and prepare it once a day. This entire process is automated using <strong>GitHub Actions</strong>.</p>
            <ol>
                <li><strong>Automated Trigger:</strong> Every day at 11:00 AM IST, GitHub Actions automatically runs a Python script.</li>
                <li><strong>Data Scraping:</strong> The script visits davjehanabad.in and downloads the raw HTML code of the birthday page.</li>
                <li><strong>Formatting:</strong> A second script reads this messy HTML, intelligently extracts only the student names, classes, and dates, and neatly organizes this information into a single, clean Excel file (`.xlsx`).</li>
            </ol>
            <h4>Part 2: The Frontend (The Interface You Use)</h4>
            <p>The frontend is designed for speed. It does all the work right inside your browser (client-side processing).</p>
            <ol>
                <li><strong>Fetching Data:</strong> When you open the page, your browser quickly fetches the single Excel file prepared by the backend.</li>
                <li><strong>In-Browser Processing:</strong> Using a JavaScript library (XLSX.js), your browser reads the Excel file and builds the table you see on the screenâ€”all without needing a server.</li>
                <li><strong>Instant Search:</strong> Since all the data is already in your browser, searching is instantaneous. The app filters the local data and redraws the table with zero delay.</li>
            </ol>
        </div>
    </div>

    <script>
        const url = 'https://birthday-api.pages.dev/Birthday%20Data%20Master.xlsx';
        
        const loadingElement = document.getElementById('loading');
        const tableContainer = document.getElementById('table-container');
        const countDisplay = document.getElementById('studentCount');
        const searchInput = document.getElementById('searchInput');

        const readMoreBtn = document.getElementById('readMoreBtn');
        const infoModal = document.getElementById('infoModal');
        const modalCloseBtn = document.getElementById('modalCloseBtn');

        let globalHeaders = [], globalData = [];
        let dateColumnIndex = -1; // To store the index of the date column

        function debounce(func, delay) {
            let timeout;
            return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); };
        }
        
        // --- NEW: Helper function to parse 'DD-Month' into a comparable Date object ---
        function parseDateFromRow(row) {
            if (dateColumnIndex === -1 || !row[dateColumnIndex]) return null;
            const dateStr = row[dateColumnIndex].replace('-', ' '); // "01-August" -> "01 August"
            const date = new Date(dateStr);
            if (isNaN(date)) return null;
            // Set a common year to make comparison easier
            date.setFullYear(new Date().getFullYear());
            return date;
        }

        async function fetchAndDisplayExcel() {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                if (jsonData.length > 0) {
                    globalHeaders = jsonData[0];
                    // Find the 'Date of Birth' column
                    dateColumnIndex = globalHeaders.findIndex(h => h.toLowerCase().includes('date'));
                    
                    globalData = jsonData.slice(1).filter(row => row.length > 0 && row.some(cell => String(cell).trim() !== ''));

                    // --- NEW: Sorting Logic ---
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const todayDayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));

                    globalData.sort((a, b) => {
                        const dateA = parseDateFromRow(a);
                        const dateB = parseDateFromRow(b);
                        
                        if (!dateA) return 1; // Put rows without dates at the end
                        if (!dateB) return -1;
                        
                        const dayOfYearA = Math.floor((dateA - new Date(dateA.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
                        const dayOfYearB = Math.floor((dateB - new Date(dateB.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
                        
                        // This logic handles year-end wrapping
                        const diffA = (dayOfYearA - todayDayOfYear + 366) % 366;
                        const diffB = (dayOfYearB - todayDayOfYear + 366) % 366;

                        return diffA - diffB;
                    });
                    
                    renderTable(globalData, true); // Render with sections initially
                    countDisplay.textContent = `Total Students: ${globalData.length}`;
                    loadingElement.style.display = 'none';
                } else {
                    loadingElement.textContent = "No data found.";
                }
            } catch (error) {
                console.error(error);
                loadingElement.innerHTML = `<span style="color:#ef4444"><i class="fa-solid fa-triangle-exclamation"></i> Error loading data.</span>`;
            }
        }

        // --- UPDATED: renderTable function to handle sections ---
        function renderTable(dataRows, showSections = false) {
            if (dataRows.length === 0) {
                tableContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#64748b;">No matching records found.</div>';
                return;
            }
            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            
            const trHead = document.createElement('tr');
            globalHeaders.forEach(text => { const th = document.createElement('th'); th.textContent = text; trHead.appendChild(th); });
            thead.appendChild(trHead);

            // Helper to create a data row
            const createDataRow = (rowData) => {
                const tr = document.createElement('tr');
                for(let i=0; i < globalHeaders.length; i++) {
                    const td = document.createElement('td');
                    td.textContent = rowData[i] || "-";
                    tr.appendChild(td);
                }
                return tr;
            };

            // Helper to create a section header row
            const createSectionHeader = (title) => {
                const tr = document.createElement('tr');
                tr.className = 'section-header';
                const td = document.createElement('td');
                td.colSpan = globalHeaders.length;
                td.innerHTML = title;
                tr.appendChild(td);
                return tr;
            };

            if (showSections && dateColumnIndex !== -1) {
                // Logic for sectioned view
                let addedTodayHeader = false, addedTomorrowHeader = false, addedUpcomingHeader = false;
                const today = new Date(); today.setHours(0,0,0,0);
                const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);

                dataRows.forEach(rowData => {
                    const bday = parseDateFromRow(rowData);
                    if (!bday) return; // Skip rows with invalid dates
                    
                    bday.setFullYear(today.getFullYear()); // Normalize year for comparison
                    
                    if (bday.getTime() === today.getTime()) {
                        if (!addedTodayHeader) {
                            tbody.appendChild(createSectionHeader("ðŸŽ‚ Today's Birthdays"));
                            addedTodayHeader = true;
                        }
                    } else if (bday.getTime() === tomorrow.getTime()) {
                        if (!addedTomorrowHeader) {
                            tbody.appendChild(createSectionHeader("ðŸŽ‰ Tomorrow's Birthdays"));
                            addedTomorrowHeader = true;
                        }
                    } else {
                        if (!addedUpcomingHeader) {
                            tbody.appendChild(createSectionHeader("ðŸ—“ï¸ Upcoming Birthdays"));
                            addedUpcomingHeader = true;
                        }
                    }
                    tbody.appendChild(createDataRow(rowData));
                });

            } else {
                // Logic for simple/filtered view
                dataRows.forEach(rowData => {
                    tbody.appendChild(createDataRow(rowData));
                });
            }

            table.appendChild(thead);
            table.appendChild(tbody);
            tableContainer.innerHTML = '';
            tableContainer.appendChild(table);
        }

        searchInput.addEventListener('keyup', debounce(function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                renderTable(globalData, true); // Re-render with sections if search is cleared
                countDisplay.textContent = `Total Students: ${globalData.length}`;
            } else {
                const filteredData = globalData.filter(row => row.map(cell => String(cell || "").toLowerCase()).join(" ").includes(searchTerm));
                renderTable(filteredData, false); // Render filtered data without sections
                countDisplay.textContent = `Matching: ${filteredData.length}`;
            }
        }, 300));
        
        fetchAndDisplayExcel();

        // Modal event listeners
        readMoreBtn.addEventListener('click', () => infoModal.classList.add('active'));
        modalCloseBtn.addEventListener('click', () => infoModal.classList.remove('active'));
        infoModal.addEventListener('click', (e) => {
            if (e.target === infoModal) infoModal.classList.remove('active');
        });
    </script>
</body>
</html>
