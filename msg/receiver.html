<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8" /><title>Receiver from GSheet</title></head>
<body>
  <h2>Receiver - Listening for notifications</h2>
  <div id="log"></div>

<script>
  const url = 'https://script.google.com/macros/s/AKfycbxM8-0zbCTaczeMkHrdzljNRDK9aoSwxzU4rqpBzA2rPWhEuE2wjuWW61_HbqYOaQNNaA/exec'; // Replace with your Apps Script Web App URL
  const log = document.getElementById('log');
  let receivedTimestamps = new Set();

  async function poll() {
    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error('Network error');
      const data = await res.json();
      for (const item of data) {
        if (!receivedTimestamps.has(item.timestamp)) {
          receivedTimestamps.add(item.timestamp);
          showNotification(item.message);
          addLog(item.timestamp + ': ' + item.message);
        }
      }
    } catch (e) {
      addLog('Poll error: ' + e.message);
    }
  }

  function addLog(msg) {
    const p = document.createElement('p');
    p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    log.prepend(p);
  }

  function showNotification(msg) {
    if (!('Notification' in window)) return;
    if (Notification.permission === 'granted') {
      new Notification('New Message', { body: msg, silent: true });
    } else if (Notification.permission !== 'denied') {
      Notification.requestPermission().then(p => {
        if (p === 'granted') {
          new Notification('New Message', { body: msg, silent: true });
        }
      });
    }
  }

  poll();
  setInterval(poll, 5000); // poll every 5 sec
</script>
</body>
</html>

